{"componentChunkName":"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx","path":"/eventstore-learnings","result":{"data":{"post":{"slug":"/eventstore-learnings","title":"EventStore - Learnings of a broken man","date":"05.06.2022","tags":[{"name":"EventStore","slug":"event-store"},{"name":"Docker","slug":"docker"}],"description":null,"canonicalUrl":null,"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"EventStore - Learnings of a broken man\",\n  \"date\": \"2022-06-05T00:00:00.000Z\",\n  \"slug\": \"/eventstore-learnings\",\n  \"tags\": [\"EventStore\", \"Docker\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", null, \"EventStore and .NET\"), mdx(\"p\", null, \"If you're looking to connect to EventStore from a .NET application, you've got three choices: HTTP, TCP and gRPC. HTTP is available for all langauges that support HTTP requests (so almost all of them). The TCP client is a package only available as a .NET SDK and has now been deprecated by EventStore. Finally, gRPC is the one to choose if you're new. It is the future of EventStore clients and has good support across a range of languages include .NET, Java and Rust(!).\"), mdx(\"h2\", null, \"The TCP Client\"), mdx(\"p\", null, \"The gRPC client was only released by EventStore in the last few years. Before that, the best option for .NET developers was the TCP client.\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"There are various modes of operation for EventStore. You have secure and insecure; single node and cluster. Setting the clients up to work with these different options is fiddly and configuration can be totally different depending on what you're aiming for. In my case, I was attempting to set up a local EventStore instance to work with the current code base without any changes to the code outside of basic socket and credential changes. This ended up requiring a secure cluster setup as no other configuration would have met my requirements (basically, I needed a copy of live), however, for local testing, the recommendation is an insecure single node as this is the least complicated and easiest to set up. \"), mdx(\"h3\", null, \"Insecure Single Node Setup\"), mdx(\"p\", null, \"My experience with EventStore's documentation is just plain bad... They're examples don't work, even when followed to the letter and a lot of important information is hidden deep within paragraphs instead of highlighted separately.\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"There are various ways of running a local EventStore instance, the one I would recommend is spinning up a container using Docker. It's simple and you get repeatable results (unless they remove their Docker image).  \"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Setup with Docker\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"For the following, you'll need to make sure you have Docker and, by extension, docker-compose installed.\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Create a new empty folder and name it something suitable (i.e. EventStoreContainer)\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Create a new file and name it docker-compose.yaml\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Add the following to the file, in our case, we're going to be running a 20.10.2 instance which is the latest LTS version of EventStore. If you want to use a different version, go to their \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://hub.docker.com/r/eventstore/eventstore/tags?page=1&ordering=last_updated\"\n  }, \"Docker Hub\"), \" page and find it's tag for reference there.  \")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"version: '3.4'\\n\\nservices:\\n  eventstore.db:\\n    image: eventstore/eventstore:20.10.2-buster-slim\\n    environment:\\n      - EVENTSTORE_CLUSTER_SIZE=1\\n      - EVENTSTORE_RUN_PROJECTIONS=All\\n      - EVENTSTORE_START_STANDARD_PROJECTIONS=true\\n      - EVENTSTORE_EXT_TCP_PORT=1113\\n      - EVENTSTORE_EXT_HTTP_PORT=2113\\n      - EVENTSTORE_INSECURE=true\\n      - EVENTSTORE_ENABLE_EXTERNAL_TCP=true\\n      - EVENTSTORE_ENABLE_ATOM_PUB_OVER_HTTP=true\\n    ports:\\n      - \\\"1113:1113\\\"\\n      - \\\"2113:2113\\\"\\n    volumes:\\n      - type: volume\\n        source: eventstore-volume-data\\n        target: /var/lib/eventstore\\n      - type: volume\\n        source: eventstore-volume-logs\\n        target: /var/log/eventstore\\n\\nvolumes:\\n  eventstore-volume-data:\\n  eventstore-volume-logs:\\n\")), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Open a command prompt in that directory and run\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"docker-compose up\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"This will start an instance of EventStore and you should see an output in the terminal window. If you have any issues connecting, this is the place to look.\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Go to \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://localhost:2113\"\n  }, \"localhost:2113\"), \" and you should now have access to the EventStore dashboard.  \"))), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"TCP Client Configuration\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Open a new CLI project in .NET in your editor of choice.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Go to the package manager and include a reference to the EventStore.Client package from NuGet. There will be a few other client options but these are the gRPC clients. \"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"The following code is going to setup a connection with TLS disabled from the client end and append an event to test-stream.  \")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"var settings = ConnectionSettings.Create()\\n            .DisableTls();\\n\\nvar conn = EventStoreConnection.Create(\\\"ConnectTo=tcp://localhost:1113\\\", settings);\\n\\nawait conn.ConnectAsync();\\n\\nvar data = Encoding.UTF8.GetBytes(\\\"{\\\\\\\"a\\\\\\\":\\\\\\\"2\\\\\\\"}\\\");\\nvar metadata = Encoding.UTF8.GetBytes(\\\"{}\\\");\\nvar evt = new EventData(Guid.NewGuid(), \\\"testEvent\\\", true, data, metadata);\\n\\nawait conn.AppendToStreamAsync(\\\"test-stream\\\", ExpectedVersion.Any, evt);\\n\")), mdx(\"p\", null, \"Before we move on, there are a few things of note here. The first is that there are multiple different ways to setup a connection to EventStore from the client that all achieve the same behaviour. This, in my opinion, is hugely confusing and unecessary. Below, I'll list some interchangable variations of line 4 that will all do the same thing.  \"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"var conn = EventStoreConnection.Create(settings.Build(), new Uri(\\\"tcp://localhost:1113\\\"))\\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-csharp\"\n  }, \"var conn = EventStoreConnection.Create(\\\"ConnectTo=tcp://localhost:1113;UseSslConnection=false\\\");\\n\")), mdx(\"p\", null, \"Anyway, moving on  \"), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"When you've run the code, switch back to your \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"http://localhost:2113\"\n  }, \"localhost:2113\"), \" tab and go to the \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"Stream Browser\"), \" tab (fyi, this would not have been available if we hadn't include the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"EVENTSTORE_ENABLE_ATOM_PUB_OVER_HTTP=true\"), \" config option in the yaml).\", mdx(\"br\", {\n    parentName: \"li\"\n  }), \"In that tab, you should see 1 recently created Stream called \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"test-stream\"), \" with one event inside it. And that's it, you've connected and successfully appended an event.  \")), mdx(\"h3\", null, \"Secure Cluster Setup\"), mdx(\"p\", null, \"Setting up EventStore as a secure cluster of nodes is what you would expect from a production environment. Ordinarily, the nodes would be on different server instances to achieve load-balancing and high-availability. In our case however, the nodes will be hosted in separate Docker instances on your local machine.  \"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Setup with Docker\"), \"  \"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Create a new empty folder and name it something suitable (i.e. EventStoreContainer)\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Create a new file and name it docker-compose.yaml\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Add the following to the file, in our case, we're going to be running a 20.10.2 instance which is the latest LTS version of EventStore. If you want to use a different version, go to their \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://hub.docker.com/r/eventstore/eventstore/tags?page=1&ordering=last_updated\"\n  }, \"Docker Hub\"), \" page and find it's tag for reference there.  \")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-yaml\"\n  }, \"version: \\\"3.5\\\"\\n\\nservices:\\n  setup:\\n    image: eventstore/es-gencert-cli:1.0.2\\n    entrypoint: bash\\n    user: \\\"1000:1000\\\"\\n    command: >\\n      -c \\\"mkdir -p ./certs && cd /certs\\n      && es-gencert-cli create-ca\\n      && es-gencert-cli create-node -out ./node1 -ip-addresses 127.0.0.1,172.30.240.11 -dns-names localhost\\n      && es-gencert-cli create-node -out ./node2 -ip-addresses 127.0.0.1,172.30.240.12 -dns-names localhost\\n      && es-gencert-cli create-node -out ./node3 -ip-addresses 127.0.0.1,172.30.240.13 -dns-names localhost\\n      && find . -type f -print0 | xargs -0 chmod 666\\\"\\n    container_name: setup\\n    volumes:\\n      - ./certs:/certs\\n\\n  node1.eventstore: &template\\n    image: eventstore/eventstore:20.10.2-buster-slim\\n    container_name: node1.eventstore\\n    env_file:\\n      - vars.env\\n    environment:\\n      - EVENTSTORE_INT_IP=172.30.240.11\\n      - EVENTSTORE_ADVERTISE_HTTP_PORT_TO_CLIENT_AS=2111\\n      - EVENTSTORE_ADVERTISE_TCP_PORT_TO_CLIENT_AS=1111\\n      - EVENTSTORE_GOSSIP_SEED=172.30.240.12:2113,172.30.240.13:2113\\n      - EVENTSTORE_TRUSTED_ROOT_CERTIFICATES_PATH=/certs/ca\\n      - EVENTSTORE_CERTIFICATE_FILE=/certs/node1/node.crt\\n      - EVENTSTORE_CERTIFICATE_PRIVATE_KEY_FILE=/certs/node1/node.key\\n    healthcheck:\\n      test:\\n        [\\n          \\\"CMD-SHELL\\\",\\n          \\\"curl --fail --insecure https://node1.eventstore:2113/health/live || exit 1\\\",\\n        ]\\n      interval: 5s\\n      timeout: 5s\\n      retries: 24\\n    ports:\\n      - 1111:1113\\n      - 2111:2113\\n    volumes:\\n      - ./certs:/certs\\n    depends_on:\\n      - setup\\n    restart: always\\n    networks:\\n      clusternetwork:\\n        ipv4_address: 172.30.240.11\\n\\n  node2.eventstore:\\n    <<: *template\\n    container_name: node2.eventstore\\n    env_file:\\n      - vars.env\\n    environment:\\n      - EVENTSTORE_INT_IP=172.30.240.12\\n      - EVENTSTORE_ADVERTISE_HTTP_PORT_TO_CLIENT_AS=2112\\n      - EVENTSTORE_ADVERTISE_TCP_PORT_TO_CLIENT_AS=1112\\n      - EVENTSTORE_GOSSIP_SEED=172.30.240.11:2113,172.30.240.13:2113\\n      - EVENTSTORE_TRUSTED_ROOT_CERTIFICATES_PATH=/certs/ca\\n      - EVENTSTORE_CERTIFICATE_FILE=/certs/node2/node.crt\\n      - EVENTSTORE_CERTIFICATE_PRIVATE_KEY_FILE=/certs/node2/node.key\\n    healthcheck:\\n      test:\\n        [\\n          \\\"CMD-SHELL\\\",\\n          \\\"curl --fail --insecure https://node2.eventstore:2113/health/live || exit 1\\\",\\n        ]\\n      interval: 5s\\n      timeout: 5s\\n      retries: 24\\n    ports:\\n      - 1112:1113\\n      - 2112:2113\\n    networks:\\n      clusternetwork:\\n        ipv4_address: 172.30.240.12\\n\\n  node3.eventstore:\\n    <<: *template\\n    container_name: node3.eventstore\\n    environment:\\n      - EVENTSTORE_INT_IP=172.30.240.13\\n      - EVENTSTORE_ADVERTISE_HTTP_PORT_TO_CLIENT_AS=2113\\n      - EVENTSTORE_ADVERTISE_TCP_PORT_TO_CLIENT_AS=1113\\n      - EVENTSTORE_GOSSIP_SEED=172.30.240.11:2113,172.30.240.12:2113\\n      - EVENTSTORE_TRUSTED_ROOT_CERTIFICATES_PATH=/certs/ca\\n      - EVENTSTORE_CERTIFICATE_FILE=/certs/node3/node.crt\\n      - EVENTSTORE_CERTIFICATE_PRIVATE_KEY_FILE=/certs/node3/node.key\\n    healthcheck:\\n      test:\\n        [\\n          \\\"CMD-SHELL\\\",\\n          \\\"curl --fail --insecure https://node3.eventstore:2113/health/live || exit 1\\\",\\n        ]\\n      interval: 5s\\n      timeout: 5s\\n      retries: 24\\n    ports:\\n      - 1113:1113\\n      - 2113:2113\\n    networks:\\n      clusternetwork:\\n        ipv4_address: 172.30.240.13\\n\\nnetworks:\\n  clusternetwork:\\n    name: eventstoredb.local\\n    driver: bridge\\n    ipam:\\n      driver: default\\n      config:\\n        - subnet: 172.30.240.0/24\\n\")), mdx(\"ol\", {\n    \"start\": 4\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Add a sub-directory to your \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"EventStoreContainer\"), \" folder called \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"certs\"))), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Open a command prompt in that directory and run\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"docker-compose up\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"This will start an instance of EventStore and you should see an output in the terminal window. If you have any issues connecting, this is the place to look.\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"After exectuing the above, the \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"es-gencert-cli\"), \" will generate a root ca and an individual certificate for each node. You don't need much knowledge of certificates here, just an understanding that without them, TLS won't work. Therefore, we're going to need to install them for you current user, even if it's only temporarily.\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Open the certs directory and install the ca certificate\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"Double click the certificate and select \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Install Certificate...\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"Select \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Current User\"), \" and click \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Next\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"Select \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Place all certificates in the following store\"), \" and click \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Browse...\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"From the list select \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Trusted Root Certification Authorities\"), \" and click \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"OK\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"Then click \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Next\"), \" and then \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Finish\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"A security warning will pop up, click \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"Yes\"), \" and the EventStoreDB CA will now be installed\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Now, go to \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://localhost:2113\"\n  }, \"https://localhost:2113\"), \" and you should have secure access with TLS.\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"In your command prompt, execute\", mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"certmgr\"), mdx(\"br\", {\n    parentName: \"p\"\n  }), \"\\n\", \"This will open up your the certificate manager for your current user. This will allow you to import and remove certificates.\"))));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"EventStore and .NET If you're looking to connect to EventStore from a .NET application, you've got three choices: HTTP, TCP and gRPC. HTTPâ€¦","timeToRead":4,"banner":null}},"pageContext":{"slug":"/eventstore-learnings","formatString":"DD.MM.YYYY"}},"staticQueryHashes":["2744905544","3090400250","318001574"]}